---
title: "Project Proposal: Sanitation Access and Malaria Rates"
author: "Hujoe Pandi Selvan, Adrian Hallak, Brandon Powell, Tymon Vu"
format: 
  html:  
    embed-resources: true
    code-tools: true
    toc: true
editor: source
execute: 
  echo: true
  warning: false
  message: false
  error: true
---

```{r setup}
library(tidyverse)
library(knitr)
library(gganimate)
library(gifski)
library(broom)
```

## Introduction

We will be exploring the relationship between **access to rural basic sanitation** and **Malaria Cases per 100,000 population** across countries over time. We will be trying to find plausible connection between public health and infrastructure.

## Data and Variables

Our datasets came from the Gapminder database, which combines data from multiple sources into one succint time series for multiple countries. Both of these datasets includes data by country and year, ranging approximately from 1990 to 2006, though coverage varies by country and indicator.

The **access to rural basic sanitation** dataset provides data about the percentage of people living in that country using the most basic sanitation services, that is, improved sanitation facilities not shared with other households. These facilities would include sewer systems, septic tanks, ventilated improved pit latrines, and compositing toilets. This indicator encompasses both people using basic sanitation services as well as those using safely managed sanitation services.

The **Malaria Cases per 100,000** dataset provides information about the number of repoted malaria cases per 100,000 people in a country in different years.

Original sources for the data are:

-   Sanitation Access: https://data.worldbank.org/indicator/SH.STA.ACSN.RU
-   Malaria Cases: https://www.who.int/tb/en/

## Hypothesis

Our hypothesis is that **higher access to rural basic sanitation is associated with lower malaria incidence**. We are expecting a negative correlation between the two chosen variables.

**Rationale:** People with access to basic sanitation facilities would help reduce standing water, exposure to waste and even other factors that aids in the spread of malaria.

According to the National Library of Medicine, "Poor sanitation can indirectly increase the risk of malaria by creating environments where mosquitoes breed more easily" ([ ](https://pmc.ncbi.nlm.nih.gov/articles/PMC9817013/)).

Hence we expect to see as sanitation improves malaria cases start to decline.

## Data Cleaning and Preparation

Before analyzing our data, we decided to combine both of our datasets by country with the overlapping years of interest from both datasets. This would only include the years from 2000-2006. We then renamed the columns coming from the malaria dataset to **malaria** and the columns coming from the access to rural basic sanitation dataest to **sanit** and pivoted the data to long format to fully display and make it easier to manipulate.

```{r}
malaria <- read_csv("Data/malaria_cases_per_100000_reported.csv")
sanit <- read_csv("Data/at_least_basic_sanitation_rural_access_percent.csv")
```

```{r}
# Get data from 2000 to 2006
years <- c("2000", "2001", "2002", "2003", "2004", "2005", "2006")

malaria_clean <- malaria |>
  select(country, years) |>
  pivot_longer(cols = `2000`:`2006` , names_to = "year", values_to = "malaria") |>
  mutate(
    malaria = case_when(
      str_detect(malaria, "k") ~ as.numeric(str_remove(malaria, "k")) * 1000,
      TRUE ~ as.numeric(malaria)
    )
  )

# Get data from 2000 to 2006
sanit_clean <- sanit |>
  select(country, years) |>
  pivot_longer(cols = `2000`:`2006` , names_to = "year", values_to = "sanit") 

cleaned <- full_join(malaria_clean, sanit_clean, by = join_by(country, year))

cleaned |>
  filter(!is.na(malaria) & !is.na(sanit)) |>
  tail(10)
```

### 2.1 Data Visualization

#### 2.1.1 Relationship Between Variables
```{r}
cleaned |>
  group_by(country) |>
  summarize(
    sanit_avg  = mean(sanit,  na.rm = TRUE),
    malaria_avg = mean(malaria, na.rm = TRUE)
  ) |>
  filter(!is.na(sanit_avg) & !is.na(malaria_avg)) |>
ggplot(aes(x = sanit_avg, y = malaria_avg)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "Average Rural Basic Sanitation (%)",
    y = "Average Malaria Cases per 100 000",
    title = "Country-level Sanitation vs. Malaria (2000–2006)"
  )
```
In this plot each point is one country’s 2000–2006 average.  We see a clear downward trend: countries with higher basic sanitation rates tend to have lower malaria incidence.

#### 2.1.2 Animation
Next we use **gganimate** to show how the same relationship shifts year by year:

```{r}
# Animation
cleaned |> 
  filter(!is.na(malaria) & !is.na(sanit), malaria > 0) |>
  ggplot(aes(x = sanit, y = malaria)) +
  geom_point() +
  scale_y_log10(labels = scales::comma) +
  labs(
    x = "Rural Basic Sanitation (%)",
    y = "Malaria Cases per 100 000 (log scale)",
    title = 'Year: {closest_state}'
  ) +
  transition_states(year,
                    transition_length = 2,
                    state_length = 2) +
  ease_aes("linear")
```

### 2.2 Linear Regression

```{r}
cleaned_count <- cleaned |>
  group_by(country) |>
  summarize(sanit = mean(sanit, na.rm = TRUE),
            malaria = mean(malaria, na.rm = TRUE)) |>
  ungroup() |>
  filter(!is.na(malaria) & !is.na(sanit),
         malaria > 0)  # exclude zero or negative values for log

# Re-fit linear model with log-transformed malaria
lm_clean <- lm(sanit ~ log10(malaria), data = cleaned_count)

# Plot with transformed y-axis
cleaned_count |>
  ggplot(aes(x = sanit, y = malaria)) +
  geom_jitter() + 
  geom_smooth(method = "lm", formula = y ~ x) + 
  scale_y_log10() +
  labs(y = "Malaria (log10)", x = "Sanitation (%)",
       title = "Log-Transformed Linear Relationship: Sanitation vs. Malaria")

```
Looking at the linear regression graph, we can see that by using a logarithmic transformation, it is much easier to visualize a relationship between Sanitation Percentage and Malaria Cases.

#### Coefficients table of fitted model

```{r}
tidy(lm_clean) |>
  knitr::kable(digits = 4,
    col.names = c("Term", "Estimate", "Std. Error", "t value", "Pr(>|t|)")
  )
```
The estimate coefficient of malaria shows a negative correlation between Sanitation Percentage and Malaria Cases.

## 2.3 Model Fit

```{r}
y <- cleaned_count$malaria
y_hat <- predict(lm_clean)


A <- sum((y - mean(y))^2) # total variance
B <- sum((y_hat - mean(y))^2) # explained variance
C <- sum((y - y_hat)^2) # unexplained variance

R2 <- B / A # calc R^2

fit_tbl <- tibble(
  Quantity = c("Var(Y)", "Var(Ŷ)", "Var(residuals)", "R-squared"),
  Value    = c(A, B, C, B/A)
)

fit_tbl |>
  knitr::kable(digits = c(NA,4))
```
With an R^2-value of 0.395, there is a moderate correlation between increases in sanitation and a subsequent decrease in malaria cases per 100,000 people. In other words, 39.5% of the variance in the model is solely explained by sanitation. This suggests that the model has good but not great quality.


## 3.1 Implement k‐fold cross validation

### Explanation of cross validation:

Cross-validation is a technique used to assess how well a predictive model generalizes to an independent dataset. Rather than evaluating the model on a single train/test split, we divide the data into _k_ “folds” and cycle through them so that each fold serves as a validation set exactly once. In this project, we chose the maximum number of folds such that each fold contains at least 10 observations. In practice, our steps were:

1) **Choose the number of folds (_k_)** where N is the total number of observations in cleaned_count. This guarantees each fold has at least 10 observations.

2) Randomly partition the data into k folds.
We generated a vector fold_ids of length N, where each element is an integer from 1 to k. Each integer appears approximately the same number of times—meaning each fold will be roughly equal in size.

3) Loop over each fold (1 through k).
For each fold index x:

Training set: All rows where fold_ids != x.

Validation set: All rows where fold_ids == x.

- Fit the regression model on the training set. In our case, we predicted rural.
- sanitation percentage (sanit) as a function of log-transformed malaria cases.
- Predict sanit for the held-out fold (test_data) using predict(mod, newdata = test_data).

Compute the fold’s R² (validation) as the ratio of “explained variance” to “total variance” of the validation responses.

4) Collect all k R² values.
We stored each fold’s validation R² in cv_r2_vec, then combined them into a tibble.

At the end, cv_results contains one R² value per fold, and avg_r2 is the average cross-validated R² across all folds.

```{r}
set.seed(2025)

N  <- nrow(cleaned_count)
k  <- floor(N / 10)
if(k < 2) stop("Too few observations to form even 2 folds with ≥10 obs each.")

fold_ids <- sample(rep(1:k, length.out = N))
```


```{r}

cv_r2_vec <- map_dbl(1:k, function(x) {

  train_data <- cleaned_count[fold_ids != x, ]
  test_data  <- cleaned_count[fold_ids == x, ]
  
  mod <- lm(sanit ~ log10(malaria), data = train_data)

  preds <- predict(mod, newdata = test_data)

  r2_val <- var(preds, na.rm = TRUE) / var(test_data$sanit, na.rm = TRUE)
  
  return(r2_val)
})
```


```{r}

cv_results <- tibble(fold = 1:k,
                     r2   = cv_r2_vec)

cv_results |>
  mutate(r2 = round(r2, 3)) |>
  knitr::kable(
    col.names = c("Fold", "R² (validation)"),
    digits = 3)

avg_r2 <- mean(cv_results$r2)
print("Average cross‐validated R² across all folds:")
round(avg_r2, 4)
```

## 3.2 Plot the results

```{r}

ggplot(cv_results, aes(x = factor(fold), y = r2)) +
  geom_point(size = 2, alpha = 0.7) +
  geom_hline(yintercept = avg_r2, linetype = "dashed", color = "blue") +
  labs(x     = "Fold Number",
       y     = expression(R^2~"(validation)"),
       title = "Distribution of Cross-Validated R² by Fold",
       subtitle = paste0("Dashed line = average R² across all ", k, " folds (≈ ",
                      round(avg_r2, 3), ")")) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.title  = element_text(size = 12))

```
### 3.2.1 How Predictive Is the Model?

- An average R² of ≈ 0.55 indicates that, on average, roughly 55 % of the variance in rural sanitation percentage can be explained by log-transformed malaria cases.
- In the context of public-health/infrastructure data, an R² in the range of 0.50–0.60 suggests a **moderate predictive relationship**.  
  - It is not so low that the model is useless, but it is also not so high that malaria alone fully explains sanitation levels.  
  - Other covariates (e.g., GDP, education, geography) likely contribute additional explanatory power.

---

### 3.2.2 Variability Between Folds

- Individual fold R² values fluctuate between **0.217 (fold 2)** and **0.792 (fold 6)**.
- Folds 2 and 9 have relatively low R² (≈ 0.22 and 0.28), whereas folds 6 and 8 achieve comparatively high R² (≈ 0.79 and 0.72).
- This spread (≈ 0.22 to 0.79) highlights that the model’s performance is somewhat **unstable across different subsets of countries**:
  - If a fold happens to include countries where the negative malaria–sanitation relationship is strongest, R² is high.
  - If a fold’s data contain countries with either very high sanitation but low malaria (or vice versa)—for example, outliers or less-typical cases—R² drops.

**Implication:**  
- The wide variability suggests that the linear model is more predictive for some subgroups of countries than others.  
- The magnitude of this variability implies we should be cautious about generalizing the model to every country. It may perform very well in some contexts but poorly in others.

---

### 3.2.3 Evidence of Overfitting?

- In cross-validation, each R² reported is on a completely held-out validation fold, so high R² in a fold is **not** due to overfitting on that fold.
- However, the fact that some folds give much larger R² (> 0.70) than others (< 0.30) could indicate that the model’s structure is capturing **idiosyncratic patterns** in certain subsets of countries:
  - If those high-R² folds correspond to “easier” subsets (e.g., countries with tightly correlated malaria/sanitation levels), the model might appear stronger than it truly is when looking at global data.
  - The lower-R² folds could reflect parts of the data where the malaria–sanitation link is weaker or influenced by confounders not in the model.
- **Overall**, the cross-validation results do **not** directly prove overfitting, but they do show that the model’s explanatory power is **inconsistent** across different data splits.  
- If we trained on all the data at once, we might obtain a single global R² (≈ 0.395 for the training set), which is actually lower than some fold-specific R² values. In that sense, the model is not overfitting in the classic sense (because the CV R² is not systematically much lower than the training R²); rather, it is capturing a real but **moderately noisy relationship**.

---

### 3.2.4 Conclusions and Recommendations

1. **Moderate Predictive Performance**  
   - With an average validation R² ≈ 0.55, the model has a **moderate ability** to predict rural sanitation based solely on malaria prevalence.  
   - A single predictor (log-transformed malaria) can explain about half of the variability, but 45 % of the variance remains unaccounted for.

2. **Data Heterogeneity**  
   - The wide spread in fold-specific R² (0.22–0.79) suggests that countries do not all follow the same malaria–sanitation pattern.  
   - Including additional predictors (e.g., urbanization rate, GDP per capita, health spending) could reduce this heterogeneity and stabilize performance.

3. **No Strong Evidence of Overfitting**  
   - Since R² is computed on out-of-sample folds, high R² values in some folds reflect genuinely strong relationships in those subsets (possibly due to more extreme or homogeneous data).  
   - Folds with low R² likely contain countries where factors other than sanitation (e.g., climate, health-campaign intensity, vector ecology) play a larger role.

4. **Next Steps**  
   - Explore whether adding a second or third predictor reduces the variability in cross-validated R² (ideally targeting an average R² above 0.6 with tighter confidence intervals).  
   - Investigate the characteristics of the low-R² folds:  
     - Do these folds contain mostly small islands, very high/very low malaria countries, or specific geographic regions?  
     - This analysis could guide feature engineering or data stratification.

**In summary**, the cross-validation exercise shows that our simple linear model is reasonably predictive on average (≈ 0.55 R²) but exhibits substantial **variability** across different subsets of countries. To improve generalization and reduce fold-to-fold inconsistency, we recommend adding more relevant covariates and/or applying data stratification (e.g., by region or economic class) in future model iterations.
